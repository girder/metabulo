- name: Create gunicorn user
  user:
    name: "gunicorn"
    shell: "/usr/sbin/nologin"
  become: true

- name: Install gunicorn
  pip:
    name: "gunicorn"
    state: "present"
    virtualenv: "{{ venv }}"
    virtualenv_command: "{{ ansible_python_interpreter }} -m venv"
  notify: Restart gunicorn
  become: true
  become_user: gunicorn

- name: Check if path for sdist is specified
  fail:
    msg: "Should pass metabulo_sdist_path variable as an extra arg"
  when: metabulo_sdist_path is not defined

- name: Copy metabulo sdist to the remote machine
  copy:
    src: "{{ metabulo_sdist_path }}"
    dest: "/tmp/metabulo-sdist.tar.gz"

- name: Install metabulo python package
  pip:
    name: "/tmp/metabulo-sdist.tar.gz"
    state: "latest"
    extra_args: "--no-cache-dir"
    virtualenv: "{{ venv }}"
    virtualenv_command: "{{ ansible_python_interpreter }} -m venv"
  notify:
    - Restart gunicorn
  become: true
  become_user: gunicorn

- name: Add gunicorn environment variables
  template:
      src: "home/gunicorn/.env"
      dest: "/home/gunicorn/.env"
      mode: 0600
  become: true
  become_user: gunicorn

- name: Install gunicorn systemd service
  template:
    src: "etc/systemd/system/gunicorn.service"
    dest: "/etc/systemd/system/gunicorn.service"
  notify: Restart gunicorn
  become: true

- name: Enable gunicorn service
  systemd:
    name: "gunicorn.service"
    daemon_reload: true
    enabled: true
    state: "started"
  become: true
